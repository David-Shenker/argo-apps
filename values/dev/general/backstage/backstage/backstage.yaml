# Backstage Developer Portal for dev cluster
# Integrations: Kubernetes, ArgoCD, Apache Airflow

# ============================================
# Upstream Backstage Chart Configuration
# ============================================
backstage:
  backstage:
    image:
      registry: ghcr.io
      repository: backstage/backstage
      tag: latest
      pullPolicy: IfNotPresent

    # Add labels for Backstage Kubernetes plugin discovery
    podLabels:
      backstage.io/kubernetes-id: backstage
    labels:
      backstage.io/kubernetes-id: backstage

    extraAppConfig:
      - filename: app-config.extra.yaml
        configMapRef: backstage-app-config

    extraEnvVars:
      # ArgoCD integration
      - name: ARGOCD_AUTH_TOKEN
        valueFrom:
          secretKeyRef:
            name: backstage-argocd-credentials
            key: token
            optional: true
      - name: ARGOCD_ADMIN_PASSWORD
        valueFrom:
          secretKeyRef:
            name: backstage-argocd-credentials
            key: password
            optional: false
      # Airflow integration
      - name: AIRFLOW_BASE_URL
        value: "http://airflow-operator-web.airflow.svc.cluster.local:8080"
      - name: AIRFLOW_USERNAME
        value: "admin"
      - name: AIRFLOW_PASSWORD
        valueFrom:
          secretKeyRef:
            name: backstage-airflow-credentials
            key: password
            optional: false

    resources:
      requests:
        cpu: 50m
        memory: 256Mi
      limits:
        cpu: 500m
        memory: 1Gi

    # Mount catalog entities
    extraVolumeMounts:
      - name: catalog
        mountPath: /app/catalog

    extraVolumes:
      - name: catalog
        configMap:
          name: backstage-catalog

  postgresql:
    enabled: true
    image:
      registry: docker.io
      repository: bitnamilegacy/postgresql
      tag: 15.4.0-debian-11-r10
    auth:
      username: backstage
      password: backstage-dev
      database: backstage_plugin_catalog
    primary:
      resources:
        requests:
          cpu: 10m
          memory: 64Mi
        limits:
          cpu: 100m
          memory: 256Mi
      persistence:
        enabled: false # Disable persistence for dev

  service:
    type: ClusterIP
    ports:
      backend: 7007
      targetPort: backend

  serviceAccount:
    create: false # Created via global-templates
    name: backstage

  ingress:
    enabled: false

# ============================================
# Global-Templates: ServiceAccount
# ============================================
serviceaccounts:
  - name: backstage
    namespace: backstage

# ============================================
# Global-Templates: ConfigMaps
# ============================================
configmaps:
  # Catalog entities
  - name: backstage-catalog
    namespace: backstage
    file_content:
      all.yaml: |
        # ============================================
        # DOMAINS
        # ============================================
        ---
        apiVersion: backstage.io/v1alpha1
        kind: Domain
        metadata:
          name: platform
          description: Platform and Infrastructure Domain
          tags: [infrastructure, platform, devops]
        spec:
          owner: platform-team

        ---
        apiVersion: backstage.io/v1alpha1
        kind: Domain
        metadata:
          name: data
          description: Data Engineering and Analytics Domain
          tags: [data, analytics, etl]
        spec:
          owner: data-team

        ---
        apiVersion: backstage.io/v1alpha1
        kind: Domain
        metadata:
          name: product
          description: Product and Customer-Facing Applications Domain
          tags: [product, customer-facing, frontend]
        spec:
          owner: product-team

        # ============================================
        # SYSTEMS
        # ============================================
        ---
        apiVersion: backstage.io/v1alpha1
        kind: System
        metadata:
          name: gitops-platform
          description: GitOps Platform powered by ArgoCD
          tags: [gitops, infrastructure, ci-cd]
        spec:
          owner: platform-team
          domain: platform

        ---
        apiVersion: backstage.io/v1alpha1
        kind: System
        metadata:
          name: data-platform
          description: Data Processing and Analytics Platform
          tags: [data, etl, analytics]
        spec:
          owner: data-team
          domain: data

        ---
        apiVersion: backstage.io/v1alpha1
        kind: System
        metadata:
          name: customer-portal
          description: Customer-Facing Web Applications
          tags: [frontend, customer, web]
        spec:
          owner: product-team
          domain: product

        # ============================================
        # TEAMS (with colors)
        # ============================================
        ---
        apiVersion: backstage.io/v1alpha1
        kind: Group
        metadata:
          name: platform-team
          description: Platform Engineering Team - Infrastructure & DevOps
          annotations:
            backstage.io/edit-url: https://github.com/org/teams/platform-team
        spec:
          type: team
          profile:
            displayName: Platform Team
            email: platform-team@example.com
            picture: https://api.dicebear.com/7.x/avataaars/svg?seed=platform
          parent: backstage
          children: []
          members:
            - alice-platform
            - bob-platform

        ---
        apiVersion: backstage.io/v1alpha1
        kind: Group
        metadata:
          name: data-team
          description: Data Engineering Team - ETL & Analytics
          annotations:
            backstage.io/edit-url: https://github.com/org/teams/data-team
        spec:
          type: team
          profile:
            displayName: Data Team
            email: data-team@example.com
            picture: https://api.dicebear.com/7.x/avataaars/svg?seed=data
          parent: backstage
          children: []
          members:
            - charlie-data
            - diana-data

        ---
        apiVersion: backstage.io/v1alpha1
        kind: Group
        metadata:
          name: product-team
          description: Product Engineering Team - Customer Applications
          annotations:
            backstage.io/edit-url: https://github.com/org/teams/product-team
        spec:
          type: team
          profile:
            displayName: Product Team
            email: product-team@example.com
            picture: https://api.dicebear.com/7.x/avataaars/svg?seed=product
          parent: backstage
          children: []
          members:
            - eve-product
            - frank-product

        # ============================================
        # USERS
        # ============================================
        ---
        apiVersion: backstage.io/v1alpha1
        kind: User
        metadata:
          name: alice-platform
          description: Platform Engineer
        spec:
          profile:
            displayName: Alice Platform
            email: alice@example.com
            picture: https://api.dicebear.com/7.x/avataaars/svg?seed=alice
          memberOf: [platform-team]

        ---
        apiVersion: backstage.io/v1alpha1
        kind: User
        metadata:
          name: bob-platform
          description: DevOps Engineer
        spec:
          profile:
            displayName: Bob Platform
            email: bob@example.com
            picture: https://api.dicebear.com/7.x/avataaars/svg?seed=bob
          memberOf: [platform-team]

        ---
        apiVersion: backstage.io/v1alpha1
        kind: User
        metadata:
          name: charlie-data
          description: Data Engineer
        spec:
          profile:
            displayName: Charlie Data
            email: charlie@example.com
            picture: https://api.dicebear.com/7.x/avataaars/svg?seed=charlie
          memberOf: [data-team]

        ---
        apiVersion: backstage.io/v1alpha1
        kind: User
        metadata:
          name: diana-data
          description: Analytics Engineer
        spec:
          profile:
            displayName: Diana Data
            email: diana@example.com
            picture: https://api.dicebear.com/7.x/avataaars/svg?seed=diana
          memberOf: [data-team]

        ---
        apiVersion: backstage.io/v1alpha1
        kind: User
        metadata:
          name: eve-product
          description: Frontend Engineer
        spec:
          profile:
            displayName: Eve Product
            email: eve@example.com
            picture: https://api.dicebear.com/7.x/avataaars/svg?seed=eve
          memberOf: [product-team]

        ---
        apiVersion: backstage.io/v1alpha1
        kind: User
        metadata:
          name: frank-product
          description: Full Stack Engineer
        spec:
          profile:
            displayName: Frank Product
            email: frank@example.com
            picture: https://api.dicebear.com/7.x/avataaars/svg?seed=frank
          memberOf: [product-team]

        ---
        apiVersion: backstage.io/v1alpha1
        kind: User
        metadata:
          name: guest
        spec:
          profile:
            displayName: Guest User
          memberOf: [platform-team]

        # ============================================
        # PLATFORM COMPONENTS (with K8s integration)
        # ============================================
        ---
        apiVersion: backstage.io/v1alpha1
        kind: Component
        metadata:
          name: argocd
          description: ArgoCD GitOps Controller - Continuous Deployment Platform
          tags: [gitops, infrastructure, kubernetes]
          annotations:
            argocd/app-name: argocd
            backstage.io/kubernetes-id: argocd
            backstage.io/kubernetes-namespace: argocd
            backstage.io/kubernetes-label-selector: 'app.kubernetes.io/name=argocd-server,app.kubernetes.io/name=argocd-repo-server,app.kubernetes.io/name=argocd-application-controller'
            github.com/project-slug: argoproj/argo-cd
            backstage.io/view-url: http://argocd-server.argocd.svc.cluster.local
            backstage.io/source-location: url:https://github.com/argoproj/argo-cd
          links:
            - url: http://argocd-server.argocd.svc.cluster.local
              title: ArgoCD UI
              icon: dashboard
            - url: https://argo-cd.readthedocs.io
              title: Documentation
              icon: docs
          labels:
            app: argocd
            tier: infrastructure
        spec:
          type: service
          lifecycle: production
          owner: platform-team
          system: gitops-platform
          providesApis:
            - argocd-api

        ---
        apiVersion: backstage.io/v1alpha1
        kind: Component
        metadata:
          name: airflow
          description: Apache Airflow DAG Orchestrator - Workflow Management Platform
          tags: [workflow, data-pipeline, orchestration]
          annotations:
            backstage.io/kubernetes-id: airflow
            backstage.io/kubernetes-namespace: airflow
            backstage.io/kubernetes-label-selector: 'component in (airflow-webserver,airflow-scheduler,airflow-worker)'
            github.com/project-slug: apache/airflow
            backstage.io/view-url: http://airflow-operator-web.airflow.svc.cluster.local:8080
            backstage.io/source-location: url:https://github.com/apache/airflow
          links:
            - url: http://airflow-operator-web.airflow.svc.cluster.local:8080
              title: Airflow UI
              icon: dashboard
            - url: https://airflow.apache.org/docs
              title: Documentation
              icon: docs
          labels:
            app: airflow
            tier: infrastructure
        spec:
          type: service
          lifecycle: production
          owner: platform-team
          system: gitops-platform
          providesApis:
            - airflow-api

        ---
        apiVersion: backstage.io/v1alpha1
        kind: Component
        metadata:
          name: backstage
          description: Backstage Developer Portal - Internal Developer Platform
          tags: [developer-portal, documentation, catalog]
          annotations:
            backstage.io/kubernetes-id: backstage
            backstage.io/kubernetes-namespace: backstage
            backstage.io/kubernetes-label-selector: 'app=backstage'
            github.com/project-slug: backstage/backstage
            backstage.io/view-url: http://localhost:7007
            backstage.io/source-location: url:https://github.com/backstage/backstage
          links:
            - url: http://localhost:7007
              title: Backstage UI
              icon: dashboard
            - url: https://backstage.io/docs
              title: Documentation
              icon: docs
          labels:
            app: backstage
            tier: infrastructure
        spec:
          type: website
          lifecycle: production
          owner: platform-team
          system: gitops-platform

        # ============================================
        # APPLICATION COMPONENTS (with K8s & ArgoCD)
        # ============================================
        ---
        apiVersion: backstage.io/v1alpha1
        kind: Component
        metadata:
          name: my-first-app
          description: My First Application - Customer-facing web service
          tags: [web, nginx, customer-facing]
          annotations:
            backstage.io/kubernetes-id: example-app
            backstage.io/kubernetes-namespace: default
            backstage.io/kubernetes-label-selector: 'app=example-app'
            argocd/app-name: my-first-app
            github.com/project-slug: org/my-first-app
            backstage.io/source-location: url:https://github.com/org/my-first-app
            backstage.io/techdocs-ref: dir:.
          links:
            - url: http://example-app.default.svc.cluster.local
              title: Service URL
              icon: web
            - url: https://github.com/org/my-first-app
              title: Source Code
              icon: code
          labels:
            app: example-app
            tier: application
        spec:
          type: service
          lifecycle: production
          owner: product-team
          system: customer-portal
          consumesApis:
            - user-api
          providesApis:
            - my-first-app-api

        ---
        apiVersion: backstage.io/v1alpha1
        kind: Component
        metadata:
          name: my-second-app
          description: My Second Application - Internal microservice
          tags: [microservice, internal, api]
          annotations:
            backstage.io/kubernetes-id: example-app-second
            backstage.io/kubernetes-namespace: default
            backstage.io/kubernetes-label-selector: 'app=example-app-second'
            argocd/app-name: my-second-app
            github.com/project-slug: org/my-second-app
            backstage.io/source-location: url:https://github.com/org/my-second-app
            backstage.io/techdocs-ref: dir:.
          links:
            - url: http://example-app-second.default.svc.cluster.local
              title: Service URL
              icon: web
            - url: https://github.com/org/my-second-app
              title: Source Code
              icon: code
          labels:
            app: example-app-second
            tier: application
        spec:
          type: service
          lifecycle: production
          owner: product-team
          system: customer-portal
          consumesApis:
            - user-api
          providesApis:
            - my-second-app-api

        # ============================================
        # AIRFLOW DAG COMPONENTS
        # ============================================
        ---
        apiVersion: backstage.io/v1alpha1
        kind: Component
        metadata:
          name: data-pipeline-dag
          description: Data Pipeline DAG - ETL workflow for processing customer records
          tags: [etl, data-pipeline, airflow]
          annotations:
            backstage.io/airflow-dag-id: data_pipeline
            backstage.io/view-url: http://airflow-operator-web.airflow.svc.cluster.local:8080/dags/data_pipeline
            github.com/project-slug: org/data-pipelines
            backstage.io/source-location: url:https://github.com/org/data-pipelines
          links:
            - url: http://airflow-operator-web.airflow.svc.cluster.local:8080/dags/data_pipeline
              title: DAG View
              icon: dashboard
            - url: https://github.com/org/data-pipelines/blob/main/dags/data_pipeline.py
              title: Source Code
              icon: code
          labels:
            dag: data-pipeline
            team: data-team
        spec:
          type: service
          lifecycle: production
          owner: data-team
          system: data-platform

        ---
        apiVersion: backstage.io/v1alpha1
        kind: Component
        metadata:
          name: health-check-dag
          description: Health Check DAG - System health monitoring and alerting
          tags: [monitoring, health-check, alerts]
          annotations:
            backstage.io/airflow-dag-id: health_check
            backstage.io/view-url: http://airflow-operator-web.airflow.svc.cluster.local:8080/dags/health_check
            github.com/project-slug: org/monitoring-pipelines
            backstage.io/source-location: url:https://github.com/org/monitoring-pipelines
          links:
            - url: http://airflow-operator-web.airflow.svc.cluster.local:8080/dags/health_check
              title: DAG View
              icon: dashboard
            - url: https://github.com/org/monitoring-pipelines/blob/main/dags/health_check.py
              title: Source Code
              icon: code
          labels:
            dag: health-check
            team: platform-team
        spec:
          type: service
          lifecycle: production
          owner: platform-team
          system: gitops-platform

        ---
        apiVersion: backstage.io/v1alpha1
        kind: Component
        metadata:
          name: report-generator-dag
          description: Report Generator DAG - Daily business intelligence reports
          tags: [reports, analytics, bi]
          annotations:
            backstage.io/airflow-dag-id: report_generator
            backstage.io/view-url: http://airflow-operator-web.airflow.svc.cluster.local:8080/dags/report_generator
            github.com/project-slug: org/analytics-pipelines
            backstage.io/source-location: url:https://github.com/org/analytics-pipelines
          links:
            - url: http://airflow-operator-web.airflow.svc.cluster.local:8080/dags/report_generator
              title: DAG View
              icon: dashboard
            - url: https://github.com/org/analytics-pipelines/blob/main/dags/report_generator.py
              title: Source Code
              icon: code
          labels:
            dag: report-generator
            team: data-team
        spec:
          type: service
          lifecycle: production
          owner: data-team
          system: data-platform

        # ============================================
        # APIs
        # ============================================
        ---
        apiVersion: backstage.io/v1alpha1
        kind: API
        metadata:
          name: argocd-api
          description: ArgoCD REST API - GitOps application management
          tags: [gitops, kubernetes, rest]
          annotations:
            backstage.io/view-url: http://argocd-server.argocd.svc.cluster.local/api/v1
            github.com/project-slug: argoproj/argo-cd
          links:
            - url: https://argo-cd.readthedocs.io/en/stable/developer-guide/api-docs
              title: API Documentation
              icon: docs
        spec:
          type: rest
          lifecycle: production
          owner: platform-team
          system: gitops-platform
          definition: |
            openapi: "3.0.0"
            info:
              title: ArgoCD API
              version: "2.0"
              description: ArgoCD REST API for managing GitOps applications
            servers:
              - url: http://argocd-server.argocd.svc.cluster.local/api/v1
            paths:
              /applications:
                get:
                  summary: List applications
                  operationId: listApplications
              /applications/{name}:
                get:
                  summary: Get application
                  operationId: getApplication

        ---
        apiVersion: backstage.io/v1alpha1
        kind: API
        metadata:
          name: airflow-api
          description: Apache Airflow REST API - DAG and workflow management
          tags: [workflow, data-pipeline, rest]
          annotations:
            backstage.io/view-url: http://airflow-operator-web.airflow.svc.cluster.local:8080/api/v1
            github.com/project-slug: apache/airflow
          links:
            - url: https://airflow.apache.org/docs/apache-airflow/stable/stable-rest-api-ref.html
              title: API Documentation
              icon: docs
        spec:
          type: rest
          lifecycle: production
          owner: platform-team
          system: gitops-platform
          definition: |
            openapi: "3.0.0"
            info:
              title: Airflow API
              version: "2.8"
              description: Apache Airflow REST API for managing DAGs and workflows
            servers:
              - url: http://airflow-operator-web.airflow.svc.cluster.local:8080/api/v1
            paths:
              /dags:
                get:
                  summary: List DAGs
                  operationId: listDags
              /dags/{dag_id}/dagRuns:
                post:
                  summary: Trigger DAG
                  operationId: triggerDag

        ---
        apiVersion: backstage.io/v1alpha1
        kind: API
        metadata:
          name: user-api
          description: User Management API - Customer and user data management
          tags: [user, customer, rest]
          annotations:
            github.com/project-slug: org/user-service
          links:
            - url: https://api.example.com/docs/user-api
              title: API Documentation
              icon: docs
        spec:
          type: rest
          lifecycle: production
          owner: product-team
          system: customer-portal
          definition: |
            openapi: "3.0.0"
            info:
              title: User API
              version: "1.0"
              description: User management REST API
            servers:
              - url: https://api.example.com/v1
            paths:
              /users:
                get:
                  summary: List users
                  operationId: listUsers
              /users/{id}:
                get:
                  summary: Get user
                  operationId: getUser

        ---
        apiVersion: backstage.io/v1alpha1
        kind: API
        metadata:
          name: my-first-app-api
          description: My First App REST API
          tags: [rest, web]
          annotations:
            github.com/project-slug: org/my-first-app
          links:
            - url: http://example-app.default.svc.cluster.local/api/docs
              title: API Documentation
              icon: docs
        spec:
          type: rest
          lifecycle: production
          owner: product-team
          system: customer-portal
          definition: |
            openapi: "3.0.0"
            info:
              title: My First App API
              version: "1.0"
            servers:
              - url: http://example-app.default.svc.cluster.local/api

        ---
        apiVersion: backstage.io/v1alpha1
        kind: API
        metadata:
          name: my-second-app-api
          description: My Second App REST API
          tags: [rest, microservice]
          annotations:
            github.com/project-slug: org/my-second-app
          links:
            - url: http://example-app-second.default.svc.cluster.local/api/docs
              title: API Documentation
              icon: docs
        spec:
          type: rest
          lifecycle: production
          owner: product-team
          system: customer-portal
          definition: |
            openapi: "3.0.0"
            info:
              title: My Second App API
              version: "1.0"
            servers:
              - url: http://example-app-second.default.svc.cluster.local/api

        # ============================================
        # RESOURCES
        # ============================================
        ---
        apiVersion: backstage.io/v1alpha1
        kind: Resource
        metadata:
          name: postgresql-database
          description: PostgreSQL Database Cluster
          tags: [database, postgresql, infrastructure]
          annotations:
            backstage.io/kubernetes-id: postgresql
            backstage.io/kubernetes-namespace: default
        spec:
          type: database
          owner: platform-team
          system: gitops-platform

        ---
        apiVersion: backstage.io/v1alpha1
        kind: Resource
        metadata:
          name: redis-cache
          description: Redis Cache Cluster
          tags: [cache, redis, infrastructure]
          annotations:
            backstage.io/kubernetes-id: redis
            backstage.io/kubernetes-namespace: default
        spec:
          type: cache
          owner: platform-team
          system: gitops-platform

        ---
        apiVersion: backstage.io/v1alpha1
        kind: Resource
        metadata:
          name: s3-storage
          description: S3 Object Storage Bucket
          tags: [storage, s3, data]
          annotations:
            backstage.io/view-url: https://s3.console.aws.amazon.com/s3/buckets/data-bucket
        spec:
          type: storage
          owner: data-team
          system: data-platform

        # ============================================
        # ADDITIONAL COMPONENTS - More Demo Content
        # ============================================
        ---
        apiVersion: backstage.io/v1alpha1
        kind: Component
        metadata:
          name: payment-service
          description: Payment Processing Microservice - Handles payment transactions
          tags: [payment, microservice, financial]
          annotations:
            backstage.io/kubernetes-id: payment-service
            backstage.io/kubernetes-namespace: production
            argocd/app-name: payment-service
            github.com/project-slug: org/payment-service
            backstage.io/source-location: url:https://github.com/org/payment-service
            backstage.io/techdocs-ref: dir:docs
          links:
            - url: https://payment.example.com
              title: Production URL
              icon: web
            - url: https://github.com/org/payment-service
              title: Source Code
              icon: code
            - url: https://payment.example.com/docs
              title: API Docs
              icon: docs
          labels:
            tier: application
            criticality: high
        spec:
          type: service
          lifecycle: production
          owner: product-team
          system: customer-portal
          consumesApis:
            - payment-gateway-api
          providesApis:
            - payment-api

        ---
        apiVersion: backstage.io/v1alpha1
        kind: Component
        metadata:
          name: notification-service
          description: Notification Service - Email, SMS, and Push notifications
          tags: [notification, messaging, communication]
          annotations:
            backstage.io/kubernetes-id: notification-service
            backstage.io/kubernetes-namespace: production
            argocd/app-name: notification-service
            github.com/project-slug: org/notification-service
            backstage.io/source-location: url:https://github.com/org/notification-service
          links:
            - url: https://github.com/org/notification-service
              title: Source Code
              icon: code
          labels:
            tier: application
        spec:
          type: service
          lifecycle: production
          owner: product-team
          system: customer-portal
          consumesApis:
            - email-api
            - sms-api

        ---
        apiVersion: backstage.io/v1alpha1
        kind: Component
        metadata:
          name: analytics-dashboard
          description: Analytics Dashboard - Real-time business metrics visualization
          tags: [analytics, dashboard, visualization]
          annotations:
            backstage.io/kubernetes-id: analytics-dashboard
            backstage.io/kubernetes-namespace: production
            argocd/app-name: analytics-dashboard
            github.com/project-slug: org/analytics-dashboard
            backstage.io/source-location: url:https://github.com/org/analytics-dashboard
          links:
            - url: https://analytics.example.com
              title: Dashboard
              icon: dashboard
            - url: https://github.com/org/analytics-dashboard
              title: Source Code
              icon: code
          labels:
            tier: application
        spec:
          type: website
          lifecycle: production
          owner: data-team
          system: data-platform
          consumesApis:
            - analytics-api

        ---
        apiVersion: backstage.io/v1alpha1
        kind: Component
        metadata:
          name: user-service
          description: User Management Service - Authentication and user profiles
          tags: [user, auth, identity]
          annotations:
            backstage.io/kubernetes-id: user-service
            backstage.io/kubernetes-namespace: production
            argocd/app-name: user-service
            github.com/project-slug: org/user-service
            backstage.io/source-location: url:https://github.com/org/user-service
          links:
            - url: https://github.com/org/user-service
              title: Source Code
              icon: code
          labels:
            tier: application
        spec:
          type: service
          lifecycle: production
          owner: product-team
          system: customer-portal
          providesApis:
            - user-api

        ---
        apiVersion: backstage.io/v1alpha1
        kind: Component
        metadata:
          name: order-service
          description: Order Management Service - E-commerce order processing
          tags: [order, ecommerce, business-logic]
          annotations:
            backstage.io/kubernetes-id: order-service
            backstage.io/kubernetes-namespace: production
            argocd/app-name: order-service
            github.com/project-slug: org/order-service
            backstage.io/source-location: url:https://github.com/org/order-service
          links:
            - url: https://github.com/org/order-service
              title: Source Code
              icon: code
          labels:
            tier: application
        spec:
          type: service
          lifecycle: production
          owner: product-team
          system: customer-portal
          consumesApis:
            - payment-api
            - inventory-api
          providesApis:
            - order-api

        ---
        apiVersion: backstage.io/v1alpha1
        kind: Component
        metadata:
          name: inventory-service
          description: Inventory Management Service - Product stock and warehouse management
          tags: [inventory, warehouse, logistics]
          annotations:
            backstage.io/kubernetes-id: inventory-service
            backstage.io/kubernetes-namespace: production
            argocd/app-name: inventory-service
            github.com/project-slug: org/inventory-service
            backstage.io/source-location: url:https://github.com/org/inventory-service
          links:
            - url: https://github.com/org/inventory-service
              title: Source Code
              icon: code
          labels:
            tier: application
        spec:
          type: service
          lifecycle: production
          owner: product-team
          system: customer-portal
          providesApis:
            - inventory-api

        ---
        apiVersion: backstage.io/v1alpha1
        kind: Component
        metadata:
          name: recommendation-engine
          description: ML Recommendation Engine - Product recommendations using machine learning
          tags: [ml, recommendation, ai]
          annotations:
            backstage.io/kubernetes-id: recommendation-engine
            backstage.io/kubernetes-namespace: production
            argocd/app-name: recommendation-engine
            github.com/project-slug: org/recommendation-engine
            backstage.io/source-location: url:https://github.com/org/recommendation-engine
          links:
            - url: https://github.com/org/recommendation-engine
              title: Source Code
              icon: code
          labels:
            tier: application
        spec:
          type: service
          lifecycle: production
          owner: data-team
          system: data-platform
          consumesApis:
            - ml-api
          providesApis:
            - recommendation-api

        ---
        apiVersion: backstage.io/v1alpha1
        kind: Component
        metadata:
          name: search-service
          description: Search Service - Full-text search and filtering
          tags: [search, elasticsearch, query]
          annotations:
            backstage.io/kubernetes-id: search-service
            backstage.io/kubernetes-namespace: production
            argocd/app-name: search-service
            github.com/project-slug: org/search-service
            backstage.io/source-location: url:https://github.com/org/search-service
          links:
            - url: https://github.com/org/search-service
              title: Source Code
              icon: code
          labels:
            tier: application
        spec:
          type: service
          lifecycle: production
          owner: product-team
          system: customer-portal
          providesApis:
            - search-api

        # ============================================
        # ADDITIONAL APIs
        # ============================================
        ---
        apiVersion: backstage.io/v1alpha1
        kind: API
        metadata:
          name: payment-api
          description: Payment Processing API - Secure payment transactions
          tags: [payment, financial, rest]
          annotations:
            github.com/project-slug: org/payment-service
          links:
            - url: https://payment.example.com/api/docs
              title: API Documentation
              icon: docs
        spec:
          type: rest
          lifecycle: production
          owner: product-team
          system: customer-portal
          definition: |
            openapi: "3.0.0"
            info:
              title: Payment API
              version: "2.0"
              description: Payment processing REST API
            servers:
              - url: https://payment.example.com/api/v2
            paths:
              /payments:
                post:
                  summary: Process payment
                  operationId: processPayment
              /payments/{id}:
                get:
                  summary: Get payment status
                  operationId: getPayment

        ---
        apiVersion: backstage.io/v1alpha1
        kind: API
        metadata:
          name: order-api
          description: Order Management API - E-commerce order operations
          tags: [order, ecommerce, rest]
          annotations:
            github.com/project-slug: org/order-service
          links:
            - url: https://order.example.com/api/docs
              title: API Documentation
              icon: docs
        spec:
          type: rest
          lifecycle: production
          owner: product-team
          system: customer-portal
          definition: |
            openapi: "3.0.0"
            info:
              title: Order API
              version: "1.0"
            servers:
              - url: https://order.example.com/api/v1
            paths:
              /orders:
                get:
                  summary: List orders
                post:
                  summary: Create order
              /orders/{id}:
                get:
                  summary: Get order

        ---
        apiVersion: backstage.io/v1alpha1
        kind: API
        metadata:
          name: inventory-api
          description: Inventory Management API - Stock and warehouse operations
          tags: [inventory, warehouse, rest]
          annotations:
            github.com/project-slug: org/inventory-service
          links:
            - url: https://inventory.example.com/api/docs
              title: API Documentation
              icon: docs
        spec:
          type: rest
          lifecycle: production
          owner: product-team
          system: customer-portal
          definition: |
            openapi: "3.0.0"
            info:
              title: Inventory API
              version: "1.0"
            servers:
              - url: https://inventory.example.com/api/v1
            paths:
              /products:
                get:
                  summary: List products
              /products/{id}/stock:
                get:
                  summary: Get stock level

        ---
        apiVersion: backstage.io/v1alpha1
        kind: API
        metadata:
          name: analytics-api
          description: Analytics API - Business metrics and reporting
          tags: [analytics, metrics, rest]
          annotations:
            github.com/project-slug: org/analytics-service
          links:
            - url: https://analytics.example.com/api/docs
              title: API Documentation
              icon: docs
        spec:
          type: rest
          lifecycle: production
          owner: data-team
          system: data-platform
          definition: |
            openapi: "3.0.0"
            info:
              title: Analytics API
              version: "1.0"
            servers:
              - url: https://analytics.example.com/api/v1
            paths:
              /metrics:
                get:
                  summary: Get metrics
              /reports:
                get:
                  summary: Generate report

        ---
        apiVersion: backstage.io/v1alpha1
        kind: API
        metadata:
          name: recommendation-api
          description: Recommendation API - ML-powered product recommendations
          tags: [ml, recommendation, rest]
          annotations:
            github.com/project-slug: org/recommendation-engine
          links:
            - url: https://recommendation.example.com/api/docs
              title: API Documentation
              icon: docs
        spec:
          type: rest
          lifecycle: production
          owner: data-team
          system: data-platform
          definition: |
            openapi: "3.0.0"
            info:
              title: Recommendation API
              version: "1.0"
            servers:
              - url: https://recommendation.example.com/api/v1
            paths:
              /recommendations:
                get:
                  summary: Get recommendations

        ---
        apiVersion: backstage.io/v1alpha1
        kind: API
        metadata:
          name: search-api
          description: Search API - Full-text search and filtering
          tags: [search, query, rest]
          annotations:
            github.com/project-slug: org/search-service
          links:
            - url: https://search.example.com/api/docs
              title: API Documentation
              icon: docs
        spec:
          type: rest
          lifecycle: production
          owner: product-team
          system: customer-portal
          definition: |
            openapi: "3.0.0"
            info:
              title: Search API
              version: "1.0"
            servers:
              - url: https://search.example.com/api/v1
            paths:
              /search:
                get:
                  summary: Search

        ---
        apiVersion: backstage.io/v1alpha1
        kind: API
        metadata:
          name: payment-gateway-api
          description: External Payment Gateway API - Third-party payment processing
          tags: [payment, external, rest]
          links:
            - url: https://stripe.com/docs/api
              title: Stripe API Docs
              icon: docs
        spec:
          type: rest
          lifecycle: production
          owner: product-team
          system: customer-portal

        ---
        apiVersion: backstage.io/v1alpha1
        kind: API
        metadata:
          name: email-api
          description: Email Service API - External email delivery service
          tags: [email, external, rest]
          links:
            - url: https://sendgrid.com/docs/api
              title: SendGrid API Docs
              icon: docs
        spec:
          type: rest
          lifecycle: production
          owner: product-team
          system: customer-portal

        ---
        apiVersion: backstage.io/v1alpha1
        kind: API
        metadata:
          name: sms-api
          description: SMS Service API - External SMS delivery service
          tags: [sms, external, rest]
          links:
            - url: https://twilio.com/docs/api
              title: Twilio API Docs
              icon: docs
        spec:
          type: rest
          lifecycle: production
          owner: product-team
          system: customer-portal

        ---
        apiVersion: backstage.io/v1alpha1
        kind: API
        metadata:
          name: ml-api
          description: Machine Learning API - ML model serving and inference
          tags: [ml, ai, rest]
          annotations:
            github.com/project-slug: org/ml-platform
          links:
            - url: https://ml.example.com/api/docs
              title: API Documentation
              icon: docs
        spec:
          type: rest
          lifecycle: production
          owner: data-team
          system: data-platform
          definition: |
            openapi: "3.0.0"
            info:
              title: ML API
              version: "1.0"
            servers:
              - url: https://ml.example.com/api/v1
            paths:
              /predict:
                post:
                  summary: Make prediction
              /models:
                get:
                  summary: List models

        # ============================================
        # ADDITIONAL RESOURCES
        # ============================================
        ---
        apiVersion: backstage.io/v1alpha1
        kind: Resource
        metadata:
          name: elasticsearch-cluster
          description: Elasticsearch Cluster - Search and analytics engine
          tags: [search, elasticsearch, infrastructure]
          annotations:
            backstage.io/kubernetes-id: elasticsearch
            backstage.io/kubernetes-namespace: production
        spec:
          type: database
          owner: product-team
          system: customer-portal

        ---
        apiVersion: backstage.io/v1alpha1
        kind: Resource
        metadata:
          name: mongodb-cluster
          description: MongoDB Cluster - Document database
          tags: [database, mongodb, nosql]
          annotations:
            backstage.io/kubernetes-id: mongodb
            backstage.io/kubernetes-namespace: production
        spec:
          type: database
          owner: product-team
          system: customer-portal

        ---
        apiVersion: backstage.io/v1alpha1
        kind: Resource
        metadata:
          name: kafka-cluster
          description: Apache Kafka Cluster - Event streaming platform
          tags: [messaging, kafka, streaming]
          annotations:
            backstage.io/kubernetes-id: kafka
            backstage.io/kubernetes-namespace: production
        spec:
          type: messaging
          owner: platform-team
          system: gitops-platform

        ---
        apiVersion: backstage.io/v1alpha1
        kind: Resource
        metadata:
          name: prometheus-monitoring
          description: Prometheus Monitoring Stack - Metrics and alerting
          tags: [monitoring, metrics, prometheus]
          annotations:
            backstage.io/kubernetes-id: prometheus
            backstage.io/kubernetes-namespace: monitoring
        spec:
          type: monitoring
          owner: platform-team
          system: gitops-platform

        ---
        apiVersion: backstage.io/v1alpha1
        kind: Resource
        metadata:
          name: grafana-dashboards
          description: Grafana Dashboards - Visualization and analytics
          tags: [monitoring, visualization, grafana]
          annotations:
            backstage.io/view-url: http://grafana.monitoring.svc.cluster.local
        spec:
          type: monitoring
          owner: platform-team
          system: gitops-platform

  # App config
  - name: backstage-app-config
    namespace: backstage
    file_content:
      app-config.extra.yaml: |
        app:
          title: Dev Backstage
          baseUrl: http://localhost:7007
          # Theme customization
          theme:
            light:
              palette:
                primary:
                  main: '#1976d2'
                secondary:
                  main: '#dc004e'
            dark:
              palette:
                primary:
                  main: '#90caf9'
                secondary:
                  main: '#f48fb1'

        organization:
          name: Acme Corporation
          logo: https://api.dicebear.com/7.x/shapes/svg?seed=acme

        backend:
          baseUrl: http://localhost:7007
          listen:
            port: 7007
          csp:
            connect-src: ["'self'", 'http:', 'https:']
          cors:
            origin: http://localhost:7007
            methods: [GET, HEAD, PATCH, POST, PUT, DELETE]
            credentials: true
          database:
            client: pg
            connection:
              host: ${POSTGRES_HOST}
              port: ${POSTGRES_PORT}
              user: ${POSTGRES_USER}
              password: ${POSTGRES_PASSWORD}
              database: backstage_plugin_catalog

        # Enable guest authentication for development
        auth:
          providers:
            guest:
              dangerouslyAllowOutsideDevelopment: true

        # Kubernetes plugin configuration
        kubernetes:
          serviceLocatorMethod:
            type: multiTenant
          clusterLocatorMethods:
            - type: config
              clusters:
                - name: dev-cluster
                  url: https://kubernetes.default.svc.cluster.local
                  authProvider: serviceAccount
                  skipTLSVerify: true
                  skipMetricsLookup: false
                  caFile: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
                  customResources:
                    - group: argoproj.io
                      apiVersion: v1alpha1
                      plural: applications
                    - group: argoproj.io
                      apiVersion: v1alpha1
                      plural: applicationsets
          # Enable pod logs and status visibility
          podMetrics:
            enabled: true
          # Object types to show
          objectTypes:
            - kind: pod
              apiVersion: v1
            - kind: service
              apiVersion: v1
            - kind: deployment
              apiVersion: apps/v1
            - kind: replicaset
              apiVersion: apps/v1
            - kind: ingress
              apiVersion: networking.k8s.io/v1
            - kind: configmap
              apiVersion: v1
            - kind: secret
              apiVersion: v1

        # ArgoCD plugin configuration
        argocd:
          baseUrl: http://argocd-server.argocd.svc.cluster.local
          username: admin
          password: ${ARGOCD_ADMIN_PASSWORD}
          appLocatorMethods:
            - type: config
              instances:
                - name: argocd
                  url: http://argocd-server.argocd.svc.cluster.local
                  token: ${ARGOCD_AUTH_TOKEN}

        # Apache Airflow plugin configuration
        airflow:
          baseUrl: http://airflow-operator-web.airflow.svc.cluster.local:8080
          username: ${AIRFLOW_USERNAME}
          password: ${AIRFLOW_PASSWORD}
          # Enable DAG triggering and log viewing
          experimental: true

        # Proxy configuration for plugins
        proxy:
          endpoints:
            '/argocd/api':
              target: http://argocd-server.argocd.svc.cluster.local/api/v1
              changeOrigin: true
              secure: false
              headers:
                Cookie: argocd.token=${ARGOCD_AUTH_TOKEN}
            '/airflow':
              target: http://airflow-operator-web.airflow.svc.cluster.local:8080
              changeOrigin: true
              secure: false
              allowedMethods: ['GET', 'POST', 'PUT', 'DELETE', 'PATCH', 'OPTIONS']
            '/airflow/api':
              target: http://airflow-operator-web.airflow.svc.cluster.local:8080/api/v1
              changeOrigin: true
              secure: false
              allowedMethods: ['GET', 'POST', 'PUT', 'DELETE', 'PATCH', 'OPTIONS']
            '/airflow/api/v1/dags':
              target: http://airflow-operator-web.airflow.svc.cluster.local:8080/api/v1/dags
              changeOrigin: true
              secure: false
              allowedMethods: ['GET', 'POST', 'PUT', 'DELETE', 'PATCH', 'OPTIONS']
            '/airflow/api/v1/dags/*':
              target: http://airflow-operator-web.airflow.svc.cluster.local:8080/api/v1/dags
              changeOrigin: true
              secure: false
              allowedMethods: ['GET', 'POST', 'PUT', 'DELETE', 'PATCH', 'OPTIONS']
            '/airflow/api/v1/dags/*/dagRuns':
              target: http://airflow-operator-web.airflow.svc.cluster.local:8080/api/v1/dags
              changeOrigin: true
              secure: false
              allowedMethods: ['GET', 'POST', 'PUT', 'DELETE', 'PATCH', 'OPTIONS']
            '/airflow/api/v1/dags/*/dagRuns/*':
              target: http://airflow-operator-web.airflow.svc.cluster.local:8080/api/v1/dags
              changeOrigin: true
              secure: false
              allowedMethods: ['GET', 'POST', 'PUT', 'DELETE', 'PATCH', 'OPTIONS']
            '/airflow/api/v1/dags/*/taskInstances':
              target: http://airflow-operator-web.airflow.svc.cluster.local:8080/api/v1/dags
              changeOrigin: true
              secure: false
              allowedMethods: ['GET', 'POST', 'PUT', 'DELETE', 'PATCH', 'OPTIONS']
            '/airflow/api/v1/dags/*/taskInstances/*/logs/*':
              target: http://airflow-operator-web.airflow.svc.cluster.local:8080/api/v1/dags
              changeOrigin: true
              secure: false
              allowedMethods: ['GET', 'POST', 'PUT', 'DELETE', 'PATCH', 'OPTIONS']
            '/airflow/health':
              target: http://airflow-operator-web.airflow.svc.cluster.local:8080/health
              changeOrigin: true
              secure: false
            '/airflow/dags':
              target: http://airflow-operator-web.airflow.svc.cluster.local:8080/dags
              changeOrigin: true
              secure: false
              allowedMethods: ['GET', 'POST', 'PUT', 'DELETE', 'PATCH', 'OPTIONS']
            '/airflow/logs':
              target: http://airflow-operator-web.airflow.svc.cluster.local:8080/logs
              changeOrigin: true
              secure: false
              allowedMethods: ['GET', 'POST', 'PUT', 'DELETE', 'PATCH', 'OPTIONS']

        # Tech docs configuration
        techdocs:
          builder: local
          generator:
            runIn: local
          publisher:
            type: local
          # Enable tech docs for components
          annotations:
            backstage.io/techdocs-ref: dir:.
          # Default tech docs location
          defaultLocation: https://github.com/org/repo/tree/main/docs

        # Software catalog configuration
        catalog:
          import:
            entityFilename: catalog-info.yaml
            pullRequestBranchName: backstage-integration
          rules:
            - allow: [Component, System, API, Resource, Location, Domain, Group, User]
          locations:
            # Example components
            - type: file
              target: /app/catalog/all.yaml
              rules:
                - allow: [Component, System, API, Resource, Domain, Group, User]
          # Enable catalog refresh
          refreshIntervalSeconds: 100

        # Search configuration
        search:
          pg:
            highlightOptions:
              useHighlight: true
              maxWordLength: 35
              minWordLength: 3
          # Enable search indexing
          enableExperimentalSearch: true

        # Lighthouse plugin (optional - for performance audits)
        lighthouse:
          baseUrl: http://localhost:3003

        # Cost Insights plugin (optional)
        costInsights:
          engineerCost: 200000
          products:
            - name: Cloud
              aggregation: [type, projectId]
            - name: Data
              aggregation: [type, projectId]

        # PagerDuty integration (optional)
        pagerduty:
          eventsBaseUrl: https://events.pagerduty.com/v2
          apiBaseUrl: https://api.pagerduty.com

        # GitHub integration
        integrations:
          github:
            - host: github.com
              token: ${GITHUB_TOKEN}
            - host: github.example.com
              token: ${GITHUB_TOKEN}
              apiBaseUrl: https://github.example.com/api/v3

        # Permission framework
        permission:
          enabled: true
          policy:
            default: allow

        # GraphQL API
        graphql:
          introspection: true

        # Sentry integration (optional)
        sentry:
          organization: acme-corp
          instance: acme-corp

        # Badges configuration
        badges:
          enabled: true

# ============================================
# Global-Templates: Secrets
# ============================================
secrets:
  # Airflow credentials for Backstage integration
  - name: backstage-airflow-credentials
    namespace: backstage
    stringData:
      password: admin

  # ArgoCD credentials for Backstage integration
  # Note: In production, use ExternalSecrets or copy from argocd namespace
  - name: backstage-argocd-credentials
    namespace: backstage
    stringData:
      password: admin
      token: ""

# ============================================
# ClusterRole for Kubernetes Plugin Access
# ============================================
clusterroles:
  - name: backstage-kubernetes-reader
    rules:
      # Core API resources
      - apiGroups: [""]
        resources:
          - pods
          - pods/log
          - pods/status
          - pods/exec
          - services
          - configmaps
          - namespaces
          - nodes
          - endpoints
          - events
          - limitranges
          - resourcequotas
          - persistentvolumeclaims
          - persistentvolumes
          - serviceaccounts
        verbs: ["get", "list", "watch"]
      # Apps API
      - apiGroups: ["apps"]
        resources:
          - deployments
          - replicasets
          - statefulsets
          - daemonsets
        verbs: ["get", "list", "watch"]
      # Batch API
      - apiGroups: ["batch"]
        resources:
          - jobs
          - cronjobs
        verbs: ["get", "list", "watch"]
      # Autoscaling API
      - apiGroups: ["autoscaling"]
        resources:
          - horizontalpodautoscalers
        verbs: ["get", "list", "watch"]
      # Networking API
      - apiGroups: ["networking.k8s.io"]
        resources:
          - ingresses
          - networkpolicies
        verbs: ["get", "list", "watch"]
      # ArgoCD resources
      - apiGroups: ["argoproj.io"]
        resources:
          - applications
          - applicationsets
          - appprojects
          - workflows
          - workflowtemplates
        verbs: ["get", "list", "watch"]
      # Metrics API
      - apiGroups: ["metrics.k8s.io"]
        resources:
          - pods
          - nodes
        verbs: ["get", "list"]

# ============================================
# ClusterRoleBinding
# ============================================
clusterrolebindings:
  - name: backstage-kubernetes-reader
    roleRef:
      kind: ClusterRole
      name: backstage-kubernetes-reader
    subjects:
      - kind: ServiceAccount
        name: backstage
        namespace: backstage

# ============================================
# ArgoCD Application Overrides
# ============================================
application:
  metadata:
    annotations:
      argocd.argoproj.io/sync-wave: "0"
      description: "Backstage Developer Portal with K8s, ArgoCD, and Airflow integrations"
  spec:
    syncPolicy:
      automated:
        prune: true
        selfHeal: true
      syncOptions:
        - CreateNamespace=true
        - ServerSideApply=true
