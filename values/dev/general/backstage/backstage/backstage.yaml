# Backstage Developer Portal for dev cluster
# Integrations: Kubernetes, ArgoCD, Apache Airflow

# ============================================
# Upstream Backstage Chart Configuration
# ============================================
backstage:
  backstage:
    image:
      registry: ghcr.io
      repository: backstage/backstage
      tag: latest
      pullPolicy: IfNotPresent

    extraAppConfig:
      - filename: app-config.extra.yaml
        configMapRef: backstage-app-config

    extraEnvVars:
      # ArgoCD integration
      - name: ARGOCD_AUTH_TOKEN
        valueFrom:
          secretKeyRef:
            name: backstage-argocd-credentials
            key: token
            optional: true
      - name: ARGOCD_ADMIN_PASSWORD
        valueFrom:
          secretKeyRef:
            name: backstage-argocd-credentials
            key: password
            optional: false
      # Airflow integration
      - name: AIRFLOW_BASE_URL
        value: "http://airflow-operator-web.airflow.svc.cluster.local:8080"
      - name: AIRFLOW_USERNAME
        value: "admin"
      - name: AIRFLOW_PASSWORD
        valueFrom:
          secretKeyRef:
            name: backstage-airflow-credentials
            key: password
            optional: false

    resources:
      requests:
        cpu: 50m
        memory: 256Mi
      limits:
        cpu: 500m
        memory: 1Gi

    # Mount catalog entities
    extraVolumeMounts:
      - name: catalog
        mountPath: /app/catalog

    extraVolumes:
      - name: catalog
        configMap:
          name: backstage-catalog

  postgresql:
    enabled: true
    image:
      registry: docker.io
      repository: bitnamilegacy/postgresql
      tag: 15.4.0-debian-11-r10
    auth:
      username: backstage
      password: backstage-dev
      database: backstage_plugin_catalog
    primary:
      resources:
        requests:
          cpu: 10m
          memory: 64Mi
        limits:
          cpu: 100m
          memory: 256Mi
      persistence:
        enabled: false # Disable persistence for dev

  service:
    type: ClusterIP
    ports:
      backend: 7007
      targetPort: backend

  serviceAccount:
    create: false # Created via global-templates
    name: backstage

  ingress:
    enabled: false

# ============================================
# Global-Templates: ServiceAccount
# ============================================
serviceaccounts:
  - name: backstage
    namespace: backstage

# ============================================
# Global-Templates: ConfigMaps
# ============================================
configmaps:
  # Catalog entities
  - name: backstage-catalog
    namespace: backstage
    file_content:
      all.yaml: |
        ---
        apiVersion: backstage.io/v1alpha1
        kind: Domain
        metadata:
          name: platform
          description: Platform and Infrastructure Domain
        spec:
          owner: platform-team

        ---
        apiVersion: backstage.io/v1alpha1
        kind: System
        metadata:
          name: gitops-platform
          description: GitOps Platform powered by ArgoCD
        spec:
          owner: platform-team
          domain: platform

        ---
        apiVersion: backstage.io/v1alpha1
        kind: Component
        metadata:
          name: argocd
          description: ArgoCD GitOps Controller
          annotations:
            argocd/app-name: argocd
            backstage.io/kubernetes-id: argocd
            backstage.io/kubernetes-namespace: argocd
        spec:
          type: service
          lifecycle: production
          owner: platform-team
          system: gitops-platform

        ---
        apiVersion: backstage.io/v1alpha1
        kind: Component
        metadata:
          name: airflow
          description: Apache Airflow DAG Orchestrator
          annotations:
            backstage.io/kubernetes-id: airflow
            backstage.io/kubernetes-namespace: airflow
        spec:
          type: service
          lifecycle: production
          owner: platform-team
          system: gitops-platform

        ---
        apiVersion: backstage.io/v1alpha1
        kind: Component
        metadata:
          name: backstage
          description: Backstage Developer Portal
          annotations:
            backstage.io/kubernetes-id: backstage
            backstage.io/kubernetes-namespace: backstage
        spec:
          type: website
          lifecycle: production
          owner: platform-team
          system: gitops-platform

        ---
        apiVersion: backstage.io/v1alpha1
        kind: Group
        metadata:
          name: platform-team
          description: Platform Engineering Team
        spec:
          type: team
          children: []

        ---
        apiVersion: backstage.io/v1alpha1
        kind: User
        metadata:
          name: guest
        spec:
          memberOf: [platform-team]

        ---
        apiVersion: backstage.io/v1alpha1
        kind: Component
        metadata:
          name: my-first-app
          description: My First Application - Example nginx app
          annotations:
            backstage.io/kubernetes-id: example-app
            backstage.io/kubernetes-namespace: default
            argocd/app-name: my-first-app
          labels:
            app: example-app
        spec:
          type: service
          lifecycle: production
          owner: platform-team
          system: gitops-platform

        ---
        apiVersion: backstage.io/v1alpha1
        kind: Component
        metadata:
          name: my-second-app
          description: My Second Application - Example nginx app
          annotations:
            backstage.io/kubernetes-id: example-app-second
            backstage.io/kubernetes-namespace: default
            argocd/app-name: my-second-app
          labels:
            app: example-app-second
        spec:
          type: service
          lifecycle: production
          owner: platform-team
          system: gitops-platform

        ---
        apiVersion: backstage.io/v1alpha1
        kind: Component
        metadata:
          name: data-pipeline-dag
          description: Data Pipeline DAG - ETL workflow for processing records
          annotations:
            backstage.io/airflow-dag-id: data_pipeline
        spec:
          type: service
          lifecycle: production
          owner: platform-team
          system: gitops-platform

        ---
        apiVersion: backstage.io/v1alpha1
        kind: Component
        metadata:
          name: health-check-dag
          description: Health Check DAG - System health monitoring and alerts
          annotations:
            backstage.io/airflow-dag-id: health_check
        spec:
          type: service
          lifecycle: production
          owner: platform-team
          system: gitops-platform

        ---
        apiVersion: backstage.io/v1alpha1
        kind: Component
        metadata:
          name: report-generator-dag
          description: Report Generator DAG - Daily business report generation
          annotations:
            backstage.io/airflow-dag-id: report_generator
        spec:
          type: service
          lifecycle: production
          owner: platform-team
          system: gitops-platform

  # App config
  - name: backstage-app-config
    namespace: backstage
    file_content:
      app-config.extra.yaml: |
        app:
          title: Dev Backstage
          baseUrl: http://localhost:7007

        organization:
          name: My Organization

        backend:
          baseUrl: http://localhost:7007
          listen:
            port: 7007
          csp:
            connect-src: ["'self'", 'http:', 'https:']
          cors:
            origin: http://localhost:7007
            methods: [GET, HEAD, PATCH, POST, PUT, DELETE]
            credentials: true
          database:
            client: pg
            connection:
              host: ${POSTGRES_HOST}
              port: ${POSTGRES_PORT}
              user: ${POSTGRES_USER}
              password: ${POSTGRES_PASSWORD}
              database: backstage_plugin_catalog

        # Enable guest authentication for development
        auth:
          providers:
            guest:
              dangerouslyAllowOutsideDevelopment: true

        # Kubernetes plugin configuration
        kubernetes:
          serviceLocatorMethod:
            type: multiTenant
          clusterLocatorMethods:
            - type: config
              clusters:
                - name: dev-cluster
                  url: https://kubernetes.default.svc.cluster.local
                  authProvider: serviceAccount
                  skipTLSVerify: true
                  skipMetricsLookup: false
                  caFile: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
                  customResources:
                    - group: argoproj.io
                      apiVersion: v1alpha1
                      plural: applications
                    - group: argoproj.io
                      apiVersion: v1alpha1
                      plural: applicationsets
          # Enable pod logs and status visibility
          podMetrics:
            enabled: true

        # ArgoCD plugin configuration
        argocd:
          baseUrl: http://argocd-server.argocd.svc.cluster.local
          username: admin
          password: ${ARGOCD_ADMIN_PASSWORD}
          appLocatorMethods:
            - type: config
              instances:
                - name: argocd
                  url: http://argocd-server.argocd.svc.cluster.local
                  token: ${ARGOCD_AUTH_TOKEN}

        # Apache Airflow plugin configuration
        airflow:
          baseUrl: http://airflow-operator-web.airflow.svc.cluster.local:8080
          username: ${AIRFLOW_USERNAME}
          password: ${AIRFLOW_PASSWORD}
          # Enable DAG triggering and log viewing
          experimental: true

        # Proxy configuration for plugins
        proxy:
          endpoints:
            '/argocd/api':
              target: http://argocd-server.argocd.svc.cluster.local/api/v1
              changeOrigin: true
              secure: false
              headers:
                Cookie: argocd.token=${ARGOCD_AUTH_TOKEN}
            '/airflow':
              target: http://airflow-operator-web.airflow.svc.cluster.local:8080
              changeOrigin: true
              secure: false
            '/airflow/api':
              target: http://airflow-operator-web.airflow.svc.cluster.local:8080/api/v1
              changeOrigin: true
              secure: false
            '/airflow/health':
              target: http://airflow-operator-web.airflow.svc.cluster.local:8080/health
              changeOrigin: true
              secure: false
            '/airflow/dags':
              target: http://airflow-operator-web.airflow.svc.cluster.local:8080/dags
              changeOrigin: true
              secure: false
            '/airflow/logs':
              target: http://airflow-operator-web.airflow.svc.cluster.local:8080/logs
              changeOrigin: true
              secure: false

        # Tech docs configuration
        techdocs:
          builder: local
          generator:
            runIn: local
          publisher:
            type: local

        # Software catalog configuration
        catalog:
          import:
            entityFilename: catalog-info.yaml
            pullRequestBranchName: backstage-integration
          rules:
            - allow: [Component, System, API, Resource, Location, Domain, Group, User]
          locations:
            # Example components
            - type: file
              target: /app/catalog/all.yaml
              rules:
                - allow: [Component, System, API, Resource, Domain, Group, User]

# ============================================
# Global-Templates: Secrets
# ============================================
secrets:
  # Airflow credentials for Backstage integration
  - name: backstage-airflow-credentials
    namespace: backstage
    stringData:
      password: admin

  # ArgoCD credentials for Backstage integration
  # Note: In production, use ExternalSecrets or copy from argocd namespace
  - name: backstage-argocd-credentials
    namespace: backstage
    stringData:
      password: admin
      token: ""

# ============================================
# ClusterRole for Kubernetes Plugin Access
# ============================================
clusterroles:
  - name: backstage-kubernetes-reader
    rules:
      # Core API resources
      - apiGroups: [""]
        resources:
          - pods
          - pods/log
          - pods/status
          - pods/exec
          - services
          - configmaps
          - namespaces
          - nodes
          - endpoints
          - events
          - limitranges
          - resourcequotas
          - persistentvolumeclaims
          - persistentvolumes
          - serviceaccounts
        verbs: ["get", "list", "watch"]
      # Apps API
      - apiGroups: ["apps"]
        resources:
          - deployments
          - replicasets
          - statefulsets
          - daemonsets
        verbs: ["get", "list", "watch"]
      # Batch API
      - apiGroups: ["batch"]
        resources:
          - jobs
          - cronjobs
        verbs: ["get", "list", "watch"]
      # Autoscaling API
      - apiGroups: ["autoscaling"]
        resources:
          - horizontalpodautoscalers
        verbs: ["get", "list", "watch"]
      # Networking API
      - apiGroups: ["networking.k8s.io"]
        resources:
          - ingresses
          - networkpolicies
        verbs: ["get", "list", "watch"]
      # ArgoCD resources
      - apiGroups: ["argoproj.io"]
        resources:
          - applications
          - applicationsets
          - appprojects
          - workflows
          - workflowtemplates
        verbs: ["get", "list", "watch"]
      # Metrics API
      - apiGroups: ["metrics.k8s.io"]
        resources:
          - pods
          - nodes
        verbs: ["get", "list"]

# ============================================
# ClusterRoleBinding
# ============================================
clusterrolebindings:
  - name: backstage-kubernetes-reader
    roleRef:
      kind: ClusterRole
      name: backstage-kubernetes-reader
    subjects:
      - kind: ServiceAccount
        name: backstage
        namespace: backstage

# ============================================
# ArgoCD Application Overrides
# ============================================
application:
  metadata:
    annotations:
      argocd.argoproj.io/sync-wave: "0"
      description: "Backstage Developer Portal with K8s, ArgoCD, and Airflow integrations"
  spec:
    syncPolicy:
      automated:
        prune: true
        selfHeal: true
      syncOptions:
        - CreateNamespace=true
        - ServerSideApply=true
