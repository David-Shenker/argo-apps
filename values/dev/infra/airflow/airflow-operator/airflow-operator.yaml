# Airflow Operator deployment for dev cluster
# MINIMAL config for low-memory environments (Kind/local)

airflow:
  # Airflow core configuration
  airflow:
    # KubernetesExecutor = no workers, no Redis needed (saves ~500MB+)
    # Tasks run as ephemeral pods
    executor: KubernetesExecutor

    image:
      repository: apache/airflow
      tag: 2.8.1-python3.11
      pullPolicy: IfNotPresent

    # Development-friendly configuration
    config:
      AIRFLOW__CORE__LOAD_EXAMPLES: "False"
      AIRFLOW__CORE__DAGS_ARE_PAUSED_AT_CREATION: "True"
      AIRFLOW__WEBSERVER__EXPOSE_CONFIG: "True"
      AIRFLOW__SCHEDULER__DAG_DIR_LIST_INTERVAL: "60"

    # Default admin user
    users:
      - username: admin
        password: admin
        role: Admin
        email: admin@example.com
        firstName: Admin
        lastName: User

  # Web UI - increased memory for stability
  web:
    replicas: 1
    resources:
      requests:
        cpu: 10m
        memory: 256Mi
      limits:
        cpu: 500m
        memory: 1Gi
    service:
      type: ClusterIP
      port: 8080

  # Scheduler - increased memory for stability
  scheduler:
    replicas: 1
    resources:
      requests:
        cpu: 10m
        memory: 256Mi
      limits:
        cpu: 500m
        memory: 1Gi

  # Celery workers - DISABLED for LocalExecutor
  workers:
    enabled: false

  # Triggerer - DISABLED to save resources
  triggerer:
    enabled: false

  # Database - PostgreSQL with minimal resources
  postgresql:
    enabled: true
    auth:
      postgresPassword: airflow-dev
      username: airflow
      password: airflow-dev
      database: airflow
    primary:
      resources:
        requests:
          cpu: 10m
          memory: 64Mi
        limits:
          cpu: 200m
          memory: 256Mi
      persistence:
        enabled: false # Disable persistence for dev

  # Redis - DISABLED (not needed for LocalExecutor)
  redis:
    enabled: false

  # DAG sync - git-sync to pull DAGs from repo
  dags:
    gitSync:
      enabled: true
      repo: "https://github.com/David-Shenker/argo-apps.git"
      branch: "dev"
      repoSubPath: "helm-charts/airflow-dags/dags"
      syncWait: 60
      resources:
        requests:
          cpu: 10m
          memory: 32Mi
        limits:
          cpu: 50m
          memory: 64Mi

  # Logs
  logs:
    persistence:
      enabled: false

  # Flower disabled
  flower:
    enabled: false

# ArgoCD application overrides
application:
  metadata:
    annotations:
      argocd.argoproj.io/sync-wave: "-5"
      description: "Apache Airflow (minimal) - DAG orchestration platform"
  spec:
    syncPolicy:
      automated:
        prune: true
        selfHeal: true
      syncOptions:
        - CreateNamespace=true
        - ServerSideApply=true
